<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Î¨∏Ï†ú ÌíÄÏù¥</title>
    <!-- MathJax for LaTeX rendering -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']]
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
            }
        };
    </script>
    <style>
        * { box-sizing: border-box; }
        
        body {
            font-family: 'Malgun Gothic', sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .quiz-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            animation: slideIn 0.5s ease-out;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .header {
            background: rgba(255,255,255,0.95);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .exam-info {
            font-weight: bold;
            color: #2c3e50;
            flex: 1;
            min-width: 200px;
        }
        
        .progress-info {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .progress-circle {
            position: relative;
            width: 60px;
            height: 60px;
        }
        
        .circle-bg {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: conic-gradient(#3498db var(--progress), #ecf0f1 0);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .timer {
            font-size: 1.2rem;
            font-weight: bold;
            color: #2ecc71;
            min-width: 120px;
        }

        .timer.warning {
            color: #e74c3c;
            animation: pulse 1s infinite;
        }
        
        .question-card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }
        
        .question-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: linear-gradient(90deg, #3498db, #2ecc71);
        }
        
        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ecf0f1;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .question-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: #3498db;
        }

        .question-meta {
            font-size: 0.9rem;
            color: #7f8c8d;
            margin-left: 15px;
        }
        
        .question-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .action-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }
        
        .btn-bookmark {
            background: #f39c12;
            color: white;
        }
        
        .btn-skip {
            background: #95a5a6;
            color: white;
        }

        .btn-save-exit {
            background: #e74c3c;
            color: white;
        }
        
        .btn-bookmark:hover, .btn-skip:hover, .btn-save-exit:hover {
            transform: scale(1.05);
        }
        
        .question-text {
            font-size: 1.3rem;
            line-height: 1.8;
            color: #2c3e50;
            margin-bottom: 30px;
            font-weight: 500;
        }

        .question-image {
            max-width: 100%;
            height: auto;
            margin: 20px 0;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        /* üÜï PDF ÏïåÎ¶º Î∞ïÏä§ Ïä§ÌÉÄÏùº */
        .image-notice {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border: 2px solid #ffc107;
            color: #856404;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
            box-shadow: 0 4px 15px rgba(255, 193, 7, 0.2);
        }

        .image-notice-content {
            flex: 1;
        }

        .image-notice strong {
            display: block;
            font-size: 1.1rem;
            margin-bottom: 8px;
            color: #856404;
        }

        .image-notice-text {
            font-size: 0.95rem;
            color: #856404;
        }

        /* üÜï PDF Ïó¥Í∏∞ Î≤ÑÌäº Ïä§ÌÉÄÏùº */
        .pdf-open-btn {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 10px;
            font-size: 1.05rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pdf-open-btn:hover {
            background: linear-gradient(135deg, #c0392b 0%, #a93226 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
        }

        .pdf-open-btn:active {
            transform: translateY(0);
        }

        /* ÎßàÌÅ¨Îã§Ïö¥ Ìëú Ïä§ÌÉÄÏùº */
        .question-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border: 2px solid #3498db;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .question-table td {
            padding: 12px 15px;
            border: 1px solid #bdc3c7;
            text-align: center;
            font-size: 1.1rem;
        }

        .question-table tr:first-child {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: bold;
        }

        .question-table tr:nth-child(even) {
            background: #f8f9fa;
        }

        .question-table tr:hover {
            background: #e3f2fd;
        }

        /* MathJax ÏàòÏãù Ïä§ÌÉÄÏùº */
        .MathJax, .mjx-chtml {
            font-size: 1.15em !important;
            margin: 5px 0;
        }
        
        .options {
            display: grid;
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .option {
            padding: 20px;
            border: 3px solid #ecf0f1;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: flex-start;
            font-size: 1.1rem;
            position: relative;
            overflow: hidden;
            background: white;
        }
        
        .option::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(52, 152, 219, 0.1), transparent);
            transition: left 0.5s;
        }
        
        .option:not(.correct):not(.incorrect):hover::before {
            left: 100%;
        }
        
        .option:not(.correct):not(.incorrect):hover {
            border-color: #3498db;
            background: #f8f9fa;
            transform: translateX(5px);
        }
        
        .option-label {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 20px;
            font-size: 1.3rem;
            flex-shrink: 0;
        }

        .option-content {
            flex: 1;
            line-height: 1.6;
        }
        
        .option.selected {
            border-color: #2ecc71;
            background: #d5f4e6;
        }
        
        .option.correct {
            border-color: #27ae60 !important;
            background: #d5f4e6 !important;
            animation: correctPulse 0.6s ease;
        }
        
        .option.incorrect {
            border-color: #e74c3c !important;
            background: #fadbd8 !important;
            animation: incorrectShake 0.6s ease;
        }
        
        @keyframes correctPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
        
        @keyframes incorrectShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        .feedback {
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            display: none;
            animation: slideDown 0.5s ease;
        }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .feedback.correct {
            background: #d5f4e6;
            border: 3px solid #27ae60;
            color: #155724;
        }
        
        .feedback.incorrect {
            background: #fadbd8;
            border: 3px solid #e74c3c;
            color: #721c24;
        }
        
        .feedback-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .navigation {
            background: white;
            padding: 25px;
            border-radius: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .nav-btn {
            padding: 15px 30px;
            border: none;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-prev {
            background: #95a5a6;
            color: white;
        }
        
        .btn-next {
            background: #3498db;
            color: white;
        }
        
        .btn-prev:hover, .btn-next:hover {
            transform: translateY(-2px);
        }
        
        .btn-prev:disabled,
        .btn-next:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }
        
        .question-counter {
            font-weight: bold;
            color: #2c3e50;
            font-size: 1.1rem;
        }
        
        .skip-indicator {
            background: #f39c12;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
            margin-left: 10px;
        }
        
        .floating-menu {
            position: fixed;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            background: white;
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
        }
        
        .floating-btn {
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }
        
        .btn-home {
            background: #e74c3c;
            color: white;
        }
        
        .btn-dashboard {
            background: #2ecc71;
            color: white;
        }
        
        .floating-btn:hover {
            transform: scale(1.1);
        }

        .completion-screen {
            text-align: center;
            padding: 40px;
        }

        .completion-screen h2 {
            color: #2ecc71;
            font-size: 2.5rem;
            margin-bottom: 30px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            border-left: 5px solid #3498db;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #3498db;
        }

        .stat-label {
            color: #7f8c8d;
        }

        .completion-actions {
            margin: 40px 0;
        }

        .completion-btn {
            margin: 10px;
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.1rem;
            transition: all 0.3s ease;
        }

        .completion-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            text-align: center;
        }

        .modal-content h3 {
            color: #2c3e50;
            margin-bottom: 20px;
        }

        .modal-content p {
            color: #7f8c8d;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .modal-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .modal-btn-primary {
            background: #3498db;
            color: white;
        }

        .modal-btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .modal-btn:hover {
            transform: translateY(-2px);
        }

        @media (max-width: 768px) {
            .quiz-container {
                padding: 10px;
            }

            .question-card {
                padding: 20px;
            }

            .option {
                padding: 15px;
            }

            .floating-menu {
                right: 10px;
            }

            .header {
                flex-direction: column;
            }

            .progress-info {
                width: 100%;
                justify-content: space-between;
            }

            .question-table td {
                padding: 8px 10px;
                font-size: 0.95rem;
            }

            /* üÜï Î™®Î∞îÏùºÏóêÏÑú PDF Î≤ÑÌäº Î†àÏù¥ÏïÑÏõÉ */
            .image-notice {
                flex-direction: column;
                text-align: center;
            }

            .pdf-open-btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="quiz-container">
        <div class="header">
            <div class="exam-info" id="examInfo">Í±¥ÏÑ§ÏïàÏ†ÑÍ∏∞ÏÇ¨ 2003ÎÖÑ 1Ìöå</div>
            <div class="progress-info">
                <div class="progress-circle">
                    <div class="circle-bg" style="--progress: 0%;">0%</div>
                </div>
                <div>
                    <div class="question-counter" id="questionCounter">1 / 120</div>
                    <div style="color: #7f8c8d; font-size: 0.9rem;">Ï†ïÎãµÎ•†: <span id="accuracyRate">0%</span></div>
                </div>
                <div class="timer" id="timer">00:00</div>
            </div>
        </div>
        
        <div class="question-card" id="questionCard">
            <div class="question-header">
                <div>
                    <span class="question-number" id="questionNumber">Î¨∏Ï†ú 1</span>
                    <span class="question-meta" id="questionMeta"></span>
                </div>
                <div class="question-actions">
                    <button class="action-btn btn-bookmark" onclick="toggleBookmark()">‚≠ê Î∂ÅÎßàÌÅ¨</button>
                    <button class="action-btn btn-skip" onclick="skipQuestion()">‚è≠Ô∏è Í±¥ÎÑàÎõ∞Í∏∞</button>
                    <button class="action-btn btn-save-exit" onclick="saveAndExit()">üíæ Ï†ÄÏû• ÌõÑ ÎÇòÍ∞ÄÍ∏∞</button>
                </div>
            </div>
            
            <div class="question-text" id="questionText">
                Î¨∏Ï†úÎ•º Î∂àÎü¨Ïò§Îäî Ï§ë...
            </div>
            
            <div class="options" id="optionsContainer">
            </div>
            
            <div class="feedback" id="feedback">
                <div class="feedback-title">Ï†ïÎãµÏûÖÎãàÎã§!</div>
            </div>
        </div>
        
        <div class="navigation">
            <button class="nav-btn btn-prev" onclick="previousQuestion()" id="prevBtn">‚óÄ Ïù¥Ï†Ñ</button>
            <div class="question-counter">
                Î¨∏Ï†ú <span id="currentNum">1</span> / <span id="totalNum">120</span>
                <span class="skip-indicator" id="skipIndicator" style="display: none;">Í±¥ÎÑàÎúÄ</span>
            </div>
            <button class="nav-btn btn-next" onclick="nextQuestion()" id="nextBtn">Îã§Ïùå ‚ñ∂</button>
        </div>
    </div>
    
    <div class="floating-menu">
        <button class="floating-btn btn-dashboard" onclick="goToDashboard()" title="ÎåÄÏãúÎ≥¥Îìú">üìä</button>
        <button class="floating-btn btn-home" onclick="goHome()" title="ÌôàÏúºÎ°ú">üè†</button>
    </div>

    <div class="modal-overlay" id="resumeModal">
        <div class="modal-content">
            <h3>üíæ Ï†ÄÏû•Îêú ÏßÑÌñâ ÏÉÅÌô© Î∞úÍ≤¨</h3>
            <p>Ïù¥Ï†ÑÏóê Ï†ÄÏû•Îêú ÌïôÏäµ ÏßÑÌñâ ÏÉÅÌô©Ïù¥ ÏûàÏäµÎãàÎã§.<br>Ïù¥Ïñ¥ÏÑú Í≥ÑÏÜç ÏßÑÌñâÌïòÏãúÍ≤†ÏäµÎãàÍπå?</p>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-primary" onclick="resumeProgress()">Í≥ÑÏÜçÌïòÍ∏∞</button>
                <button class="modal-btn modal-btn-secondary" onclick="startFresh()">ÏÉàÎ°ú ÏãúÏûë</button>
            </div>
        </div>
    </div>

    <script>
        let currentQuestions = [];
        let currentQuestionIndex = 0;
        let selectedAnswer = null;
        let skippedQuestions = new Set();
        let bookmarkedQuestions = new Set();
        let totalQuestions = 0;
        let startTime = Date.now();
        let timerInterval;
        let timeLimit = null;
        let timeWarningShown = false;
        let questionAnswerState = {};

        const config = JSON.parse(localStorage.getItem('quizConfig') || '{}');
        const mode = localStorage.getItem('quizMode') || 'full';

        document.addEventListener('DOMContentLoaded', function() {
            loadBookmarks();
            checkSavedProgress();
        });

        // üÜï PDF ÌååÏùºÎ™Ö ÏÉùÏÑ± Ìï®Ïàò
        function getPdfFileName(question) {
            // configÏóêÏÑú fileName Í∞ÄÏ†∏Ïò§Í∏∞
            if (config.sessionInfo && config.sessionInfo.fileName) {
                return config.sessionInfo.fileName.replace('.csv', '.pdf');
            }
            
            // question Ï†ïÎ≥¥Î°ú ÏÉùÏÑ± (fallback)
            const testName = question.testName || '';
            const year = question.year || '';
            const session = question.session || '';
            
            // ÏãúÌóòÎ™Ö ‚Üí ÏòÅÏñ¥ Îß§Ìïë (complete-migration-pdf.jsÏôÄ ÎèôÏùº)
            const examNameMap = {
                'Í±¥ÏÑ§ÏïàÏ†ÑÍ∏∞ÏÇ¨': 'const-safety',
                'Í±¥ÏÑ§ÏïàÏ†ÑÏÇ∞ÏóÖÍ∏∞ÏÇ¨': 'const-safety-ind',
                'ÏÇ∞ÏóÖÏïàÏ†ÑÍ∏∞ÏÇ¨': 'ind-safety',
                'ÏÇ∞ÏóÖÏïàÏ†ÑÏÇ∞ÏóÖÍ∏∞ÏÇ¨': 'ind-safety-ind',
                'ÏÇ∞ÏóÖÏúÑÏÉùÍ¥ÄÎ¶¨Í∏∞ÏÇ¨': 'ind-hygiene',
                'ÏÇ∞ÏóÖÏúÑÏÉùÍ¥ÄÎ¶¨ÏÇ∞ÏóÖÍ∏∞ÏÇ¨': 'ind-hygiene-ind',
                'Ïù∏Í∞ÑÍ≥µÌïôÍ∏∞ÏÇ¨': 'ergonomics',
                'ÏÇ∞ÏóÖÏïàÏ†ÑÏßÄÎèÑÏÇ¨': 'ind-safety-advisor',
                'ÏúÑÌóòÎ¨ºÍ∏∞Îä•Ïû•': 'hazmat-master',
                'ÏúÑÌóòÎ¨ºÏÇ∞ÏóÖÍ∏∞ÏÇ¨': 'hazmat-ind',
                'ÏúÑÌóòÎ¨ºÍ∏∞Îä•ÏÇ¨': 'hazmat-tech',
                'ÏÜåÎ∞©ÏÑ§ÎπÑÍ∏∞ÏÇ¨(Í∏∞Í≥ÑÎ∂ÑÏïº)': 'fire-equip-mech',
                'ÏÜåÎ∞©ÏÑ§ÎπÑÍ∏∞ÏÇ¨(Í∏∞Í≥Ñ)': 'fire-equip-mech',
                'ÏÜåÎ∞©ÏÑ§ÎπÑÍ∏∞ÏÇ¨(Ï†ÑÍ∏∞Î∂ÑÏïº)': 'fire-equip-elec',
                'ÏÜåÎ∞©ÏÑ§ÎπÑÍ∏∞ÏÇ¨(Ï†ÑÍ∏∞)': 'fire-equip-elec',
                'ÏÜåÎ∞©ÏÑ§ÎπÑÏÇ∞ÏóÖÍ∏∞ÏÇ¨(Í∏∞Í≥Ñ)': 'fire-equip-ind-mech',
                'ÏÜåÎ∞©ÏÑ§ÎπÑÏÇ∞ÏóÖÍ∏∞ÏÇ¨(Ï†ÑÍ∏∞)': 'fire-equip-ind-elec',
                'ÏÜåÎ∞©ÏãúÏÑ§Í¥ÄÎ¶¨ÏÇ¨': 'fire-facility-mgr',
                'ÏÜåÎ∞©ÏïàÏ†ÑÍµêÏú°ÏÇ¨': 'fire-safety-edu',
                'ÏÜåÎ∞©Í≥µÎ¨¥Ïõê(Í≥µÍ∞ú, Í≤ΩÎ†•)': 'firefighter',
                'ÏÜåÎ∞©Í≥µÎ¨¥Ïõê(Í≥µÍ∞ú,Í≤ΩÎ†•)': 'firefighter',
                'ÏÜåÎ∞©Í≥µÎ¨¥Ïõê(Í≤ΩÎ†•)': 'firefighter',
                'ÏÜåÎ∞©Í≥µÎ¨¥Ïõê(Í≥µÍ∞ú)': 'firefighter',
                'ÌôîÏû¨Í∞êÏãùÌèâÍ∞ÄÍ∏∞ÏÇ¨': 'fire-investigation',
                'ÌôîÏû¨Í∞êÏãùÏÇ∞ÏóÖÍ∏∞ÏÇ¨': 'fire-investigation-ind',
                'ÌôîÏû¨Í∞êÏãùÌèâÍ∞ÄÏÇ∞ÏóÖÍ∏∞ÏÇ¨': 'fire-investigation-ind',
                'Í≤ΩÎπÑÏßÄÎèÑÏÇ¨(ÏÜåÎ∞©Ìïô)': 'security-fire',
                'Í≤ΩÎπÑÏßÄÎèÑÏÇ¨2Ï∞®(ÏÜåÎ∞©Ìïô)': 'security-fire',
                'Î∞©Ïû¨Í∏∞ÏÇ¨': 'disaster-prev',
                'Î∞©Ïû¨ÏïàÏ†ÑÏßÅ(Íµ≠Í∞Ä9Í∏â)': 'nat-9-disaster',
                'Î∞©Ïû¨ÏïàÏ†ÑÏßÅ 9Í∏â(Íµ≠Í∞ÄÏßÅ)': 'nat-9-disaster',
                'Íµ≠Í∞Ä9Í∏â': 'nat-9-disaster',
                'Î∞©Ïû¨ÏïàÏ†ÑÏßÅ(Íµ≠Í∞Ä7Í∏â)': 'nat-7-disaster',
                'Î∞©Ïû¨ÏïàÏ†ÑÏßÅ 7Í∏â(Íµ≠Í∞ÄÏßÅ)': 'nat-7-disaster',
                'Íµ≠Í∞Ä7Í∏â': 'nat-7-disaster',
                'Î∞©Ïû¨ÏïàÏ†ÑÏßÅ(ÏßÄÎ∞©9Í∏â)': 'local-9-disaster',
                'Î∞©Ïû¨ÏïàÏ†ÑÏßÅ 9Í∏â(ÏßÄÎ∞©ÏßÅ)': 'local-9-disaster',
                'ÏßÄÎ∞©9Í∏â': 'local-9-disaster'
            };
            
            // ÌöåÏ∞® Î≥ÄÌôò (ÏïàÏ†ÑÍ¥ÄÎ¶¨Î°† ‚Üí safety, Ïû¨ÎÇúÍ¥ÄÎ¶¨Î°† ‚Üí disaster)
            const sessionMap = {
                'ÏïàÏ†ÑÍ¥ÄÎ¶¨Î°†': 'safety',
                'Ïû¨ÎÇúÍ¥ÄÎ¶¨Î°†': 'disaster',
                'Î∞©Ïû¨Í¥ÄÍ≥ÑÎ≤ïÍ∑ú': 'law',
                'ÎèÑÏãúÍ≥ÑÌöç': 'urban'
            };
            
            const examCode = examNameMap[testName] || 'unknown';
            const sessionCode = sessionMap[session] || session.replace('Ìöå', '').trim();
            
            return `${examCode}-${year}-${sessionCode}.pdf`;
        }

        // üÜï PDF ÏÉà ÌÉ≠ÏóêÏÑú Ïó¥Í∏∞ Ìï®Ïàò
        function openPdf(fileName) {
            const pdfPath = `/data/${fileName}`;
            
            // ÏÉà ÌÉ≠ÏóêÏÑú PDF Ïó¥Í∏∞
            const newWindow = window.open(pdfPath, '_blank');
            
            if (!newWindow) {
                alert('‚ö†Ô∏è ÌåùÏóÖÏù¥ Ï∞®Îã®ÎêòÏóàÏäµÎãàÎã§.\nÎ∏åÎùºÏö∞Ï†Ä ÏÑ§Ï†ïÏóêÏÑú ÌåùÏóÖÏùÑ ÌóàÏö©Ìï¥Ï£ºÏÑ∏Ïöî.');
            }
        }

        function checkSavedProgress() {
            const savedProgress = localStorage.getItem('quizProgress');
            if (savedProgress) {
                try {
                    const progress = JSON.parse(savedProgress);
                    if (progress.sessionId === config.session && progress.mode === mode) {
                        document.getElementById('resumeModal').classList.add('active');
                        return;
                    }
                } catch (e) {
                    console.error('ÏßÑÌñâ ÏÉÅÌô© Î°úÎìú Ïò§Î•ò:', e);
                }
            }
            startFresh();
        }

        function resumeProgress() {
            try {
                const savedProgress = JSON.parse(localStorage.getItem('quizProgress'));
                
                currentQuestionIndex = savedProgress.currentIndex || 0;
                questionAnswerState = savedProgress.questionAnswerState || {};
                skippedQuestions = new Set(savedProgress.skippedQuestions || []);
                startTime = savedProgress.startTime || Date.now();
                
                document.getElementById('resumeModal').classList.remove('active');
                
                loadQuestions(true);
            } catch (e) {
                console.error('ÏßÑÌñâ ÏÉÅÌô© Î≥µÍµ¨ Ïò§Î•ò:', e);
                startFresh();
            }
        }

        function startFresh() {
            localStorage.removeItem('quizProgress');
            document.getElementById('resumeModal').classList.remove('active');
            loadQuestions(false);
        }

        function loadBookmarks() {
            const saved = localStorage.getItem('bookmarkedQuestions');
            if (saved) {
                try {
                    bookmarkedQuestions = new Set(JSON.parse(saved));
                } catch (e) {
                    console.error('Î∂ÅÎßàÌÅ¨ Î°úÎìú Ïò§Î•ò:', e);
                    bookmarkedQuestions = new Set();
                }
            }
        }

        function saveBookmarks() {
            localStorage.setItem('bookmarkedQuestions', JSON.stringify(Array.from(bookmarkedQuestions)));
        }

        function toggleBookmark() {
            const question = currentQuestions[currentQuestionIndex];
            const questionId = generateQuestionId(question, currentQuestionIndex);
            
            if (bookmarkedQuestions.has(questionId)) {
                bookmarkedQuestions.delete(questionId);
                document.querySelector('.btn-bookmark').textContent = '‚≠ê Î∂ÅÎßàÌÅ¨';
                document.querySelector('.btn-bookmark').style.background = '#f39c12';
                
                const bookmarkDetails = JSON.parse(localStorage.getItem('bookmarkDetails') || '{}');
                delete bookmarkDetails[questionId];
                localStorage.setItem('bookmarkDetails', JSON.stringify(bookmarkDetails));
            } else {
                const bookmarkData = {
                    questionId: questionId,
                    examId: config.session || 'unknown',
                    questionIndex: currentQuestionIndex,
                    question: question,
                    addedDate: new Date().toISOString()
                };
                bookmarkedQuestions.add(questionId);
                
                const bookmarkDetails = JSON.parse(localStorage.getItem('bookmarkDetails') || '{}');
                bookmarkDetails[questionId] = bookmarkData;
                localStorage.setItem('bookmarkDetails', JSON.stringify(bookmarkDetails));
                
                document.querySelector('.btn-bookmark').textContent = '‚≠ê Î∂ÅÎßàÌÅ¨Îê®';
                document.querySelector('.btn-bookmark').style.background = '#e67e22';
            }
            saveBookmarks();
        }

        function generateQuestionId(question, index) {
            const session = config.session || 'unknown';
            const subject = question.subject || 'general';
            const qid = question.id || question.Number || index;
            const qtext = (question.question || question.Question || '').substring(0, 30).replace(/[^a-zA-Z0-9Í∞Ä-Ìû£]/g, '');
            return `${session}_${subject}_${qid}_${qtext}`;
        }

        // ÎßàÌÅ¨Îã§Ïö¥ ÌëúÎ•º HTML ÌÖåÏù¥Î∏îÎ°ú Î≥ÄÌôòÌïòÎäî Ìï®Ïàò
        function convertMarkdownTable(text) {
            const lines = text.split('\\n').map(line => line.trim()).filter(line => line);
            
            if (lines.length < 2) return text;
            
            let html = '<table class="question-table">';
            
            lines.forEach((line, idx) => {
                html += '<tr>';
                const cells = line.split('|').map(cell => cell.trim()).filter(cell => cell);
                cells.forEach(cell => {
                    html += `<td>${cell}</td>`;
                });
                html += '</tr>';
            });
            
            html += '</table>';
            return html;
        }

        async function loadQuestions(isResume = false) {
            try {
                if (mode === 'wrong' || mode === 'bookmark' || mode === 'subject') {
                    const savedQuestions = JSON.parse(localStorage.getItem('quizData') || '[]');
                    
                    if (!Array.isArray(savedQuestions) || savedQuestions.length === 0) {
                        alert('Î¨∏Ï†úÍ∞Ä ÏóÜÏäµÎãàÎã§. ÎåÄÏãúÎ≥¥ÎìúÎ°ú ÎèåÏïÑÍ∞ëÎãàÎã§.');
                        window.location.href = 'quiz.html';
                        return;
                    }
                    
                    currentQuestions = savedQuestions.map(q => normalizeQuestion(q));
                    totalQuestions = currentQuestions.length;
                    
                } else {
                    const sessionId = config.session;
                    
                    if (!sessionId) {
                        throw new Error('ÏÑ∏ÏÖò Ï†ïÎ≥¥Í∞Ä ÏóÜÏäµÎãàÎã§.');
                    }
                    
                    console.log('Loading questions from:', sessionId);
                    const response = await fetch(`/api/exams/${sessionId}`);
                    const data = await response.json();
                    
                    if (data.error) {
                        alert(data.error);
                        return;
                    }
                    
                    currentQuestions = data.questions.map(q => normalizeQuestion(q));
                    totalQuestions = currentQuestions.length;
                    
                    if (mode === 'random') {
                        const randomCount = Math.min(20, totalQuestions);
                        if (!isResume) {
                            currentQuestions = shuffleArray(currentQuestions).slice(0, randomCount);
                            localStorage.setItem('randomQuestions', JSON.stringify(currentQuestions));
                        } else {
                            const savedRandom = localStorage.getItem('randomQuestions');
                            if (savedRandom) {
                                try {
                                    currentQuestions = JSON.parse(savedRandom).map(q => normalizeQuestion(q));
                                } catch (e) {
                                    console.error('ÎûúÎç§ Î¨∏Ï†ú Î°úÎìú Ïò§Î•ò:', e);
                                    currentQuestions = shuffleArray(currentQuestions).slice(0, randomCount);
                                }
                            } else {
                                currentQuestions = shuffleArray(currentQuestions).slice(0, randomCount);
                            }
                        }
                        totalQuestions = currentQuestions.length;
                    }
                }
                
                console.log(`${totalQuestions}Í∞ú Î¨∏Ï†ú Î°úÎìú ÏôÑÎ£å`);
                
                if (!isResume) {
                    questionAnswerState = {};
                    currentQuestions.forEach((_, index) => {
                        questionAnswerState[index] = { answered: false, correct: false };
                    });
                }
                
                document.getElementById('totalNum').textContent = totalQuestions;
                document.getElementById('examInfo').textContent = getModeTitle();
                displayQuestion();
                
                startTimer();
                setupKeyboardNavigation();
                
            } catch (error) {
                console.error('Î¨∏Ï†ú Î°úÎìú Ïò§Î•ò:', error);
                alert('Î¨∏Ï†úÎ•º Î∂àÎü¨Ïò§Îäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.\n\n' + error.message);
                window.location.href = 'quiz.html';
            }
        }

        function normalizeQuestion(q) {
            return {
                id: q.id || q.Number || q.number || '',
                question: q.question || q.Question || '',
                questionImage: q.questionImage || q.Question_image || '',
                a: q.a || q['Option 1'] || q.option1 || '',
                b: q.b || q['Option 2'] || q.option2 || '',
                c: q.c || q['Option 3'] || q.option3 || '',
                d: q.d || q['Option 4'] || q.option4 || '',
                answer: String(q.answer || q.Answer || '').trim().toUpperCase(),
                explanation: q.explanation || q.Explanation || '',
                testName: q.testName || q['Test Name'] || '',
                year: q.year || q.Year || '',
                session: q.session || q.Session || '',
                subject: q.subject || q.Subject || ''
            };
        }

        function getModeTitle() {
            const modeNames = {
                'full': 'Ï†ÑÏ≤¥ Î¨∏Ï†ú',
                'wrong': 'Ïò§ÎãµÎÖ∏Ìä∏ Î≥µÏäµ',
                'bookmark': 'Î∂ÅÎßàÌÅ¨ Î≥µÏäµ',
                'random': 'ÎûúÎç§ 20Î¨∏Ï†ú',
                'timer': 'ÌÉÄÏù¥Î®∏ Î™®Îìú',
                'subject': localStorage.getItem('selectedSubject') || 'Í≥ºÎ™©Î≥Ñ ÌïôÏäµ'
            };
            return modeNames[mode] || 'Î¨∏Ï†ú ÌíÄÏù¥';
        }

        // MathJax ÏïàÏ†Ñ Î†åÎçîÎßÅ Ìï®Ïàò (Í∞úÏÑ†Îê®)
        function renderMathJax(element) {
            if (!element) return;
            
            if (typeof MathJax !== 'undefined' && MathJax.typesetPromise) {
                MathJax.typesetPromise([element]).catch((err) => {
                    console.log('MathJax Î†åÎçîÎßÅ Ïò§Î•ò:', err);
                });
            } else if (typeof MathJax !== 'undefined' && MathJax.Hub) {
                MathJax.Hub.Queue(['Typeset', MathJax.Hub, element]);
            } else {
                setTimeout(() => renderMathJax(element), 100);
            }
        }

        function displayQuestion() {
            if (currentQuestionIndex >= currentQuestions.length) {
                showCompletionScreen();
                return;
            }

            const question = currentQuestions[currentQuestionIndex];

            document.getElementById('questionNumber').textContent = `Î¨∏Ï†ú ${currentQuestionIndex + 1}`;
            
            const metaInfo = [];
            if (question.subject) metaInfo.push(question.subject);
            if (question.year) metaInfo.push(`${question.year}ÎÖÑ`);
            if (question.session) metaInfo.push(`${question.session}Ìöå`);
            document.getElementById('questionMeta').textContent = metaInfo.length > 0 ? `(${metaInfo.join(' ')})` : '';
            
            const questionTextDiv = document.getElementById('questionText');
            let questionText = question.question || 'Î¨∏Ï†ú ÎÇ¥Ïö©Ïù¥ ÏóÜÏäµÎãàÎã§.';
            
            // \nÏùÑ <br>Î°ú Î≥ÄÌôòÌïòÎêò, Ìëú ÌòïÏãùÏù¥Î©¥ ÌÖåÏù¥Î∏îÎ°ú Î≥ÄÌôò
            if (questionText.includes('\\n') && questionText.includes('|')) {
                questionText = convertMarkdownTable(questionText);
            } else {
                questionText = questionText.replace(/\\n/g, '<br>');
            }
            
            questionTextDiv.innerHTML = questionText;
            
            // üÜï Ïù¥ÎØ∏ÏßÄ Ìè¨Ìï® Ïó¨Î∂Ä ÌôïÏù∏ Î∞è PDF Î≤ÑÌäº ÌëúÏãú
            const hasImage = question.questionImage && 
                            question.questionImage.trim() !== '' && 
                            question.questionImage.toUpperCase() !== 'X';
            
            if (hasImage) {
                if (question.questionImage.toUpperCase() === 'O') {
                    // Ïù¥ÎØ∏ÏßÄÍ∞Ä ÏûàÎã§Îäî ÌëúÏãúÎßå ÏûàÎäî Í≤ΩÏö∞ - PDF Î≤ÑÌäº ÌëúÏãú
                    const imageNotice = document.createElement('div');
                    imageNotice.className = 'image-notice';
                    
                    const pdfFileName = getPdfFileName(question);
                    
                    imageNotice.innerHTML = `
                        <div class="image-notice-content">
                            <strong>üìÑ Ïù¥ Î¨∏Ï†úÏóêÎäî Ïù¥ÎØ∏ÏßÄÍ∞Ä Ìè¨Ìï®ÎêòÏñ¥ ÏûàÏäµÎãàÎã§.</strong>
                            <div class="image-notice-text">ÏõêÎ≥∏ PDF ÌååÏùºÏùÑ ÏÉà ÌÉ≠ÏóêÏÑú ÌôïÏù∏ÌïòÏÑ∏Ïöî.</div>
                        </div>
                        <button onclick="openPdf('${pdfFileName}')" class="pdf-open-btn">
                            üîó PDF Ïó¥Í∏∞
                        </button>
                    `;
                    questionTextDiv.appendChild(imageNotice);
                } else {
                    // Ïã§Ï†ú Ïù¥ÎØ∏ÏßÄ URLÏù¥ ÏûàÎäî Í≤ΩÏö∞
                    const imgElement = document.createElement('img');
                    imgElement.src = question.questionImage;
                    imgElement.className = 'question-image';
                    imgElement.alt = 'Î¨∏Ï†ú Ïù¥ÎØ∏ÏßÄ';
                    imgElement.onerror = function() {
                        this.style.display = 'none';
                        const imageNotice = document.createElement('div');
                        imageNotice.className = 'image-notice';
                        
                        const pdfFileName = getPdfFileName(question);
                        
                        imageNotice.innerHTML = `
                            <div class="image-notice-content">
                                <strong>‚ö†Ô∏è Ïù¥ÎØ∏ÏßÄÎ•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.</strong>
                                <div class="image-notice-text">ÏõêÎ≥∏ PDF ÌååÏùºÏùÑ ÏÉà ÌÉ≠ÏóêÏÑú ÌôïÏù∏ÌïòÏÑ∏Ïöî.</div>
                            </div>
                            <button onclick="openPdf('${pdfFileName}')" class="pdf-open-btn">
                                üîó PDF Ïó¥Í∏∞
                            </button>
                        `;
                        questionTextDiv.appendChild(imageNotice);
                    };
                    questionTextDiv.appendChild(imgElement);
                }
            }
            
            // MathJax Î†åÎçîÎßÅ
            renderMathJax(questionTextDiv);
            
            document.getElementById('currentNum').textContent = currentQuestionIndex + 1;
            document.getElementById('questionCounter').textContent = `${currentQuestionIndex + 1} / ${totalQuestions}`;
            
            const progress = Math.round((currentQuestionIndex / totalQuestions) * 100);
            document.querySelector('.circle-bg').style.setProperty('--progress', `${progress}%`);
            document.querySelector('.circle-bg').textContent = `${progress}%`;
            
            const skipIndicator = document.getElementById('skipIndicator');
            skipIndicator.style.display = skippedQuestions.has(currentQuestionIndex) ? 'inline' : 'none';

            const questionId = generateQuestionId(question, currentQuestionIndex);
            if (bookmarkedQuestions.has(questionId)) {
                document.querySelector('.btn-bookmark').textContent = '‚≠ê Î∂ÅÎßàÌÅ¨Îê®';
                document.querySelector('.btn-bookmark').style.background = '#e67e22';
            } else {
                document.querySelector('.btn-bookmark').textContent = '‚≠ê Î∂ÅÎßàÌÅ¨';
                document.querySelector('.btn-bookmark').style.background = '#f39c12';
            }

            const container = document.getElementById('optionsContainer');
            container.innerHTML = '';
            
            const options = ['a', 'b', 'c', 'd'];
            const labels = ['A', 'B', 'C', 'D'];
            
            options.forEach((option, index) => {
                const div = document.createElement('div');
                div.className = 'option';
                div.setAttribute('data-option', labels[index]);
                div.setAttribute('data-number', index + 1);
                
                div.onclick = (function(optLabel, optNumber) {
                    return function() {
                        selectAnswer(this, optLabel, optNumber);
                    };
                })(labels[index], index + 1);
                
                let optionText = question[option] || `ÏÑ†ÌÉùÏßÄ ${labels[index]}`;
                
                // ÏÑ†ÌÉùÏßÄÎèÑ Ïù¥Ï§ë Î∞±Ïä¨ÎûòÏãú Î≥ÄÌôò
                optionText = optionText.replace(/\\\\/g, '\\');
                
                div.innerHTML = `
                    <div class="option-label">${labels[index]}</div>
                    <div class="option-content">${optionText}</div>
                `;
                container.appendChild(div);
                
                // ÏÑ†ÌÉùÏßÄÏóêÎèÑ MathJax Î†åÎçîÎßÅ Ï†ÅÏö©
                const optionContent = div.querySelector('.option-content');
                if (optionContent) {
                    renderMathJax(optionContent);
                }
            });

            document.getElementById('feedback').style.display = 'none';
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            updateAccuracyRate();
        }

        function selectAnswer(element, letter, number) {
            const question = currentQuestions[currentQuestionIndex];
            const correctAnswer = question.answer;
            
            const wasAnswered = questionAnswerState[currentQuestionIndex].answered;
            selectedAnswer = number;

            const allOptions = document.querySelectorAll('.option');
            allOptions.forEach(opt => {
                opt.style.pointerEvents = 'none';
                opt.style.cursor = 'default';
            });

            const isCorrect = checkAnswer(letter, number, correctAnswer);
            
            if (!wasAnswered) {
                questionAnswerState[currentQuestionIndex].answered = true;
                questionAnswerState[currentQuestionIndex].correct = isCorrect;
            }
            
            if (isCorrect) {
                element.classList.add('correct');
                showFeedback(true, 'üéâ Ï†ïÎãµÏûÖÎãàÎã§!');
            } else {
                element.classList.add('incorrect');
                showFeedback(false, `‚ùå ÌãÄÎ†∏ÏäµÎãàÎã§. Ï†ïÎãµÏùÄ ${correctAnswer}Î≤àÏûÖÎãàÎã§.`);
                
                const correctIndex = getCorrectOptionIndex(correctAnswer);
                
                if (correctIndex >= 0 && correctIndex < allOptions.length) {
                    allOptions[correctIndex].classList.add('correct');
                }
                
                if (!wasAnswered) {
                    saveWrongAnswer(question);
                }
            }

            // üÜï ÏÉÅÏÑ∏ ÎãµÏïà Í∏∞Î°ù Ï†ÄÏû• Ï∂îÍ∞Ä
            saveDetailedAnswer(question, letter, correctAnswer, isCorrect);

            skippedQuestions.delete(currentQuestionIndex);
            updateAccuracyRate();
            saveCurrentProgress();
        }


        function updateAccuracyRate() {
            let answeredCount = 0;
            let correctCount = 0;
            
            for (let key in questionAnswerState) {
                if (questionAnswerState[key].answered) {
                    answeredCount++;
                    if (questionAnswerState[key].correct) {
                        correctCount++;
                    }
                }
            }
            
            const accuracy = answeredCount > 0 ? Math.round((correctCount / answeredCount) * 100) : 0;
            document.getElementById('accuracyRate').textContent = `${accuracy}%`;
        }

        function checkAnswer(letter, number, correctAnswer) {
            const normalizedCorrect = String(correctAnswer).trim().toUpperCase();
            const normalizedLetter = String(letter).trim().toUpperCase();
            const normalizedNumber = String(number).trim();
            
            if (normalizedNumber === normalizedCorrect) return true;
            if (normalizedLetter === normalizedCorrect) return true;
            
            const letterToNumber = { 'A': '1', 'B': '2', 'C': '3', 'D': '4' };
            const numberToLetter = { '1': 'A', '2': 'B', '3': 'C', '4': 'D' };
            
            if (letterToNumber[normalizedLetter] === normalizedCorrect) return true;
            if (normalizedLetter === numberToLetter[normalizedCorrect]) return true;
            
            return false;
        }

        function getCorrectOptionIndex(correctAnswer) {
            const normalized = String(correctAnswer).trim().toUpperCase();
            
            const letterMap = { 'A': 0, 'B': 1, 'C': 2, 'D': 3 };
            if (letterMap.hasOwnProperty(normalized)) {
                return letterMap[normalized];
            }
            
            const numberMap = { '1': 0, '2': 1, '3': 2, '4': 3 };
            if (numberMap.hasOwnProperty(normalized)) {
                return numberMap[normalized];
            }
            
            const num = parseInt(normalized);
            if (!isNaN(num) && num >= 1 && num <= 4) {
                return num - 1;
            }
            
            return -1;
        }

        function showFeedback(isCorrect, message) {
            const feedback = document.getElementById('feedback');
            feedback.className = `feedback ${isCorrect ? 'correct' : 'incorrect'}`;
            feedback.querySelector('.feedback-title').textContent = message;
            feedback.style.display = 'block';
        }

        function saveWrongAnswer(question) {
            try {
                const wrongAnswers = JSON.parse(localStorage.getItem('wrongAnswers') || '[]');
                const questionId = generateQuestionId(question, currentQuestionIndex);
                const exists = wrongAnswers.some(wrong => wrong.questionId === questionId);
                
                if (!exists) {
                    const wrongQuestion = {
                        ...question,
                        questionId: questionId,
                        examId: config.session || 'unknown',
                        questionIndex: currentQuestionIndex,
                        subject: question.subject || 'Í≥ºÎ™©ÎØ∏ÏßÄÏ†ï',
                        addedDate: new Date().toISOString()
                    };
                    wrongAnswers.push(wrongQuestion);
                    localStorage.setItem('wrongAnswers', JSON.stringify(wrongAnswers));
                }
            } catch (e) {
                console.error('Ïò§Îãµ Ï†ÄÏû• Ïò§Î•ò:', e);
            }
        }

        function skipQuestion() {
            skippedQuestions.add(currentQuestionIndex);
            saveCurrentProgress();
            nextQuestion();
        }

        function nextQuestion() {
            if (currentQuestionIndex < currentQuestions.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
            } else {
                showCompletionScreen();
            }
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                displayQuestion();
            }
        }

        function startTimer() {
            if (mode === 'timer') {
                timeLimit = totalQuestions * 90 * 1000;
                document.getElementById('timer').style.color = '#2ecc71';
            }
            
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            
            timerInterval = setInterval(() => {
                const elapsed = Date.now() - startTime;
                
                if (mode === 'timer' && timeLimit) {
                    const remaining = timeLimit - elapsed;
                    
                    if (remaining <= 0) {
                        clearInterval(timerInterval);
                        alert('ÏãúÍ∞ÑÏù¥ Ï¥àÍ≥ºÎêòÏóàÏäµÎãàÎã§! ÏãúÌóòÏù¥ Ï¢ÖÎ£åÎê©ÎãàÎã§.');
                        showCompletionScreen();
                        return;
                    }
                    
                    const minutes = Math.floor(remaining / 60000);
                    const seconds = Math.floor((remaining % 60000) / 1000);
                    const timerElement = document.getElementById('timer');
                    timerElement.textContent = `‚è± ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    
                    if (remaining <= 300000 && !timeWarningShown) {
                        timeWarningShown = true;
                        timerElement.classList.add('warning');
                        alert('‚ö†Ô∏è ÎÇ®ÏùÄ ÏãúÍ∞ÑÏù¥ 5Î∂ÑÏûÖÎãàÎã§!');
                    }
                    
                    if (remaining <= 60000) {
                        timerElement.classList.add('warning');
                    }
                } else {
                    const minutes = Math.floor(elapsed / 60000);
                    const seconds = Math.floor((elapsed % 60000) / 1000);
                    document.getElementById('timer').textContent = 
                        `üïê ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }
            }, 1000);
        }

        function setupKeyboardNavigation() {
            document.addEventListener('keydown', (e) => {
                if (document.querySelector('.modal-overlay.active')) return;
                
                const options = document.querySelectorAll('.option');
                const isAnswered = Array.from(options).some(opt => 
                    opt.classList.contains('correct') || opt.classList.contains('incorrect')
                );
                
                if (isAnswered && (e.key >= '1' && e.key <= '4')) return;
                
                if (e.key >= '1' && e.key <= '4') {
                    e.preventDefault();
                    const index = parseInt(e.key) - 1;
                    if (options[index]) {
                        options[index].click();
                    }
                } else if (e.key === ' ') {
                    e.preventDefault();
                    skipQuestion();
                } else if (e.key === 'ArrowLeft') {
                    e.preventDefault();
                    previousQuestion();
                } else if (e.key === 'ArrowRight') {
                    e.preventDefault();
                    nextQuestion();
                }
            });
        }

        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        function saveCurrentProgress() {
            try {
                const progress = {
                    sessionId: config.session,
                    mode: mode,
                    currentIndex: currentQuestionIndex,
                    questionAnswerState: questionAnswerState,
                    skippedQuestions: Array.from(skippedQuestions),
                    bookmarkedQuestions: Array.from(bookmarkedQuestions),
                    startTime: startTime,
                    savedAt: Date.now()
                };
                
                if (mode === 'random') {
                    progress.randomQuestions = currentQuestions;
                }
                
                localStorage.setItem('quizProgress', JSON.stringify(progress));
            } catch (e) {
                console.error('ÏßÑÌñâ ÏÉÅÌô© Ï†ÄÏû• Ïò§Î•ò:', e);
            }
        }

        function saveAndExit() {
            saveCurrentProgress();
            alert('üíæ ÏßÑÌñâ ÏÉÅÌô©Ïù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!\n\nÎã§ÏùåÏóê Îã§Ïãú Ï†ëÏÜçÌïòÎ©¥ Ïù¥Ïñ¥ÏÑú ÌíÄ Ïàò ÏûàÏäµÎãàÎã§.');
            window.location.href = 'quiz.html';
        }

        function showCompletionScreen() {
            clearInterval(timerInterval);
            localStorage.removeItem('quizProgress');
            localStorage.removeItem('randomQuestions');
            saveStudyRecord();
            
            const elapsed = Date.now() - startTime;
            const minutes = Math.floor(elapsed / 60000);
            const seconds = Math.floor((elapsed % 60000) / 1000);
            const timeString = `${minutes}Î∂Ñ ${seconds}Ï¥à`;
            
            let answeredCount = 0;
            let correctCount = 0;
            
            for (let key in questionAnswerState) {
                if (questionAnswerState[key].answered) {
                    answeredCount++;
                    if (questionAnswerState[key].correct) {
                        correctCount++;
                    }
                }
            }
            
            const accuracy = answeredCount > 0 ? Math.round((correctCount / answeredCount) * 100) : 0;
            const skippedCount = skippedQuestions.size;
            const wrongCount = answeredCount - correctCount;
            
            const questionCard = document.querySelector('.question-card');
            questionCard.innerHTML = `
                <div class="completion-screen">
                    <h2>üéâ ÌïôÏäµ ÏôÑÎ£å!</h2>
                    
                    <div class="stats-grid">
                        <div class="stat-card" style="border-left-color: #3498db;">
                            <div class="stat-value" style="color: #3498db;">${totalQuestions}</div>
                            <div class="stat-label">Ï¥ù Î¨∏Ï†ú Ïàò</div>
                        </div>
                        
                        <div class="stat-card" style="border-left-color: #9b59b6;">
                            <div class="stat-value" style="color: #9b59b6;">${answeredCount}</div>
                            <div class="stat-label">ÎãµÎ≥ÄÌïú Î¨∏Ï†ú</div>
                        </div>
                        
                        <div class="stat-card" style="border-left-color: #2ecc71;">
                            <div class="stat-value" style="color: #2ecc71;">${correctCount}</div>
                            <div class="stat-label">Ï†ïÎãµ Ïàò</div>
                        </div>

                        <div class="stat-card" style="border-left-color: #e74c3c;">
                            <div class="stat-value" style="color: #e74c3c;">${wrongCount}</div>
                            <div class="stat-label">Ïò§Îãµ Ïàò</div>
                        </div>
                        
                        <div class="stat-card" style="border-left-color: #1abc9c;">
                            <div class="stat-value" style="color: #1abc9c;">${accuracy}%</div>
                            <div class="stat-label">Ï†ïÎãµÎ•†</div>
                        </div>
                        
                        <div class="stat-card" style="border-left-color: #f39c12;">
                            <div class="stat-value" style="color: #f39c12;">${skippedCount}</div>
                            <div class="stat-label">Í±¥ÎÑàÎõ¥ Î¨∏Ï†ú</div>
                        </div>
                        
                        <div class="stat-card" style="border-left-color: #34495e;">
                            <div class="stat-value" style="color: #34495e;">${timeString}</div>
                            <div class="stat-label">ÏÜåÏöî ÏãúÍ∞Ñ</div>
                        </div>
                    </div>
                    
                    <div class="completion-actions">
                        ${skippedCount > 0 ? `
                            <button class="completion-btn" onclick="reviewSkipped()" style="background: #f39c12; color: white;">
                                ‚è≠Ô∏è Í±¥ÎÑàÎõ¥ Î¨∏Ï†ú Î≥µÏäµ
                            </button>
                        ` : ''}
                        ${wrongCount > 0 ? `
                            <button class="completion-btn" onclick="reviewWrong()" style="background: #e74c3c; color: white;">
                                ‚ùå ÌãÄÎ¶∞ Î¨∏Ï†ú Î≥µÏäµ
                            </button>
                        ` : ''}
                        <button class="completion-btn" onclick="goToDashboard()" style="background: #2ecc71; color: white;">
                            üìä ÎåÄÏãúÎ≥¥ÎìúÎ°ú
                        </button>
                        <button class="completion-btn" onclick="restartQuiz()" style="background: #3498db; color: white;">
                            üîÑ Îã§Ïãú ÌíÄÍ∏∞
                        </button>
                    </div>
                    
                    <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px; border-left: 4px solid #3498db;">
                        <p style="margin: 0; color: #2c3e50; font-weight: bold;">üìä ÌïôÏäµ Í∏∞Î°ùÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!</p>
                        <p style="margin: 10px 0 0 0; color: #7f8c8d; font-size: 0.9rem;">
                            ÎåÄÏãúÎ≥¥ÎìúÏóêÏÑú ÏûêÏÑ∏Ìïú ÌÜµÍ≥ÑÎ•º ÌôïÏù∏ÌïòÏÑ∏Ïöî.<br>
                            ${wrongCount > 0 ? 'ÌãÄÎ¶∞ Î¨∏Ï†úÎäî Ïò§ÎãµÎÖ∏Ìä∏Ïóê ÏûêÎèôÏúºÎ°ú Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.' : 'Î™®Îì† Î¨∏Ï†úÎ•º ÎßûÏ∑ÑÏäµÎãàÎã§! üéä'}
                        </p>
                    </div>
                </div>
            `;
            
            document.querySelector('.navigation').style.display = 'none';
        }

        function saveStudyRecord() {
            try {
                const studyHistory = JSON.parse(localStorage.getItem('studyHistory') || '[]');
                
                let answeredCount = 0;
                let correctCount = 0;
                
                for (let key in questionAnswerState) {
                    if (questionAnswerState[key].answered) {
                        answeredCount++;
                        if (questionAnswerState[key].correct) {
                            correctCount++;
                        }
                    }
                }
                
                const subjectStats = {};
                currentQuestions.forEach((q, idx) => {
                    if (questionAnswerState[idx] && questionAnswerState[idx].answered) {
                        const subject = q.subject || 'Í∏∞ÌÉÄ';
                        if (!subjectStats[subject]) {
                            subjectStats[subject] = { answered: 0, correct: 0 };
                        }
                        subjectStats[subject].answered++;
                        if (questionAnswerState[idx].correct) {
                            subjectStats[subject].correct++;
                        }
                    }
                });
                
                const record = {
                    date: new Date().toISOString().split('T')[0],
                    examId: config.session || 'unknown',
                    mode: mode,
                    answered: answeredCount,
                    correct: correctCount,
                    totalQuestions: totalQuestions,
                    accuracy: answeredCount > 0 ? Math.round((correctCount / answeredCount) * 100) : 0,
                    timeSpent: Date.now() - startTime,
                    subjects: subjectStats,
                    timestamp: new Date().toISOString()
                };
                
                studyHistory.push(record);
                
                if (studyHistory.length > 100) {
                    studyHistory.splice(0, studyHistory.length - 100);
                }
                
                localStorage.setItem('studyHistory', JSON.stringify(studyHistory));
            } catch (e) {
                console.error('ÌïôÏäµ Í∏∞Î°ù Ï†ÄÏû• Ïò§Î•ò:', e);
            }
        }

        function reviewSkipped() {
            if (skippedQuestions.size === 0) {
                alert('Í±¥ÎÑàÎõ¥ Î¨∏Ï†úÍ∞Ä ÏóÜÏäµÎãàÎã§.');
                return;
            }
            
            const skippedArray = Array.from(skippedQuestions).sort((a, b) => a - b);
            
            const navElement = document.querySelector('.navigation');
            const questionCard = document.getElementById('questionCard');
            
            if (navElement) {
                navElement.style.display = 'flex';
            }
            
            if (questionCard && document.querySelector('.completion-screen')) {
                questionCard.innerHTML = `
                    <div class="question-header">
                        <div>
                            <span class="question-number" id="questionNumber">Î¨∏Ï†ú 1</span>
                            <span class="question-meta" id="questionMeta"></span>
                        </div>
                        <div class="question-actions">
                            <button class="action-btn btn-bookmark" onclick="toggleBookmark()">‚≠ê Î∂ÅÎßàÌÅ¨</button>
                            <button class="action-btn btn-skip" onclick="skipQuestion()">‚è≠Ô∏è Í±¥ÎÑàÎõ∞Í∏∞</button>
                            <button class="action-btn btn-save-exit" onclick="saveAndExit()">üíæ Ï†ÄÏû• ÌõÑ ÎÇòÍ∞ÄÍ∏∞</button>
                        </div>
                    </div>
                    
                    <div class="question-text" id="questionText">
                        Î¨∏Ï†úÎ•º Î∂àÎü¨Ïò§Îäî Ï§ë...
                    </div>
                    
                    <div class="options" id="optionsContainer">
                    </div>
                    
                    <div class="feedback" id="feedback">
                        <div class="feedback-title">Ï†ïÎãµÏûÖÎãàÎã§!</div>
                    </div>
                `;
            }
            
            currentQuestionIndex = skippedArray[0];
            displayQuestion();
        }

        function reviewWrong() {
            const wrongIndices = [];
            for (let key in questionAnswerState) {
                if (questionAnswerState[key].answered && !questionAnswerState[key].correct) {
                    wrongIndices.push(parseInt(key));
                }
            }
            
            if (wrongIndices.length === 0) {
                alert('ÌãÄÎ¶∞ Î¨∏Ï†úÍ∞Ä ÏóÜÏäµÎãàÎã§!');
                return;
            }
            
            const navElement = document.querySelector('.navigation');
            const questionCard = document.getElementById('questionCard');
            
            if (navElement) {
                navElement.style.display = 'flex';
            }
            
            if (questionCard && document.querySelector('.completion-screen')) {
                questionCard.innerHTML = `
                    <div class="question-header">
                        <div>
                            <span class="question-number" id="questionNumber">Î¨∏Ï†ú 1</span>
                            <span class="question-meta" id="questionMeta"></span>
                        </div>
                        <div class="question-actions">
                            <button class="action-btn btn-bookmark" onclick="toggleBookmark()">‚≠ê Î∂ÅÎßàÌÅ¨</button>
                            <button class="action-btn btn-skip" onclick="skipQuestion()">‚è≠Ô∏è Í±¥ÎÑàÎõ∞Í∏∞</button>
                            <button class="action-btn btn-save-exit" onclick="saveAndExit()">üíæ Ï†ÄÏû• ÌõÑ ÎÇòÍ∞ÄÍ∏∞</button>
                        </div>
                    </div>
                    
                    <div class="question-text" id="questionText">
                        Î¨∏Ï†úÎ•º Î∂àÎü¨Ïò§Îäî Ï§ë...
                    </div>
                    
                    <div class="options" id="optionsContainer">
                    </div>
                    
                    <div class="feedback" id="feedback">
                        <div class="feedback-title">Ï†ïÎãµÏûÖÎãàÎã§!</div>
                    </div>
                `;
            }
            
            currentQuestionIndex = wrongIndices[0];
            displayQuestion();
        }

        function restartQuiz() {
            if (confirm('Ï≤òÏùåÎ∂ÄÌÑ∞ Îã§Ïãú ÏãúÏûëÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n\n' + 
                       (mode === 'random' ? 'ÏÉàÎ°úÏö¥ ÎûúÎç§ Î¨∏Ï†úÍ∞Ä ÏÑ†ÌÉùÎê©ÎãàÎã§.' : 'Î™®Îì† ÏßÑÌñâ ÏÉÅÌô©Ïù¥ Ï¥àÍ∏∞ÌôîÎê©ÎãàÎã§.'))) {
                
                currentQuestionIndex = 0;
                skippedQuestions.clear();
                startTime = Date.now();
                timeWarningShown = false;
                questionAnswerState = {};
                
                if (mode === 'random') {
                    localStorage.removeItem('randomQuestions');
                }
                
                localStorage.removeItem('quizProgress');
                
                const navElement = document.querySelector('.navigation');
                const questionCard = document.getElementById('questionCard');
                
                if (navElement) {
                    navElement.style.display = 'flex';
                }
                
                if (questionCard) {
                    questionCard.innerHTML = `
                        <div class="question-header">
                            <div>
                                <span class="question-number" id="questionNumber">Î¨∏Ï†ú 1</span>
                                <span class="question-meta" id="questionMeta"></span>
                            </div>
                            <div class="question-actions">
                                <button class="action-btn btn-bookmark" onclick="toggleBookmark()">‚≠ê Î∂ÅÎßàÌÅ¨</button>
                                <button class="action-btn btn-skip" onclick="skipQuestion()">‚è≠Ô∏è Í±¥ÎÑàÎõ∞Í∏∞</button>
                                <button class="action-btn btn-save-exit" onclick="saveAndExit()">üíæ Ï†ÄÏû• ÌõÑ ÎÇòÍ∞ÄÍ∏∞</button>
                            </div>
                        </div>
                        
                        <div class="question-text" id="questionText">
                            Î¨∏Ï†úÎ•º Î∂àÎü¨Ïò§Îäî Ï§ë...
                        </div>
                        
                        <div class="options" id="optionsContainer">
                        </div>
                        
                        <div class="feedback" id="feedback">
                            <div class="feedback-title">Ï†ïÎãµÏûÖÎãàÎã§!</div>
                        </div>
                    `;
                }
                
                clearInterval(timerInterval);
                loadQuestions(false);
            }
        }

        function goToDashboard() {
            if (currentQuestionIndex < currentQuestions.length && !document.querySelector('.completion-screen')) {
                if (confirm('üíæ ÏßÑÌñâ ÏÉÅÌô©ÏùÑ Ï†ÄÏû•ÌïòÍ≥† ÎÇòÍ∞ÄÏãúÍ≤†ÏäµÎãàÍπå?\n\n"ÌôïÏù∏"ÏùÑ ÎàÑÎ•¥Î©¥ Ï†ÄÏû• ÌõÑ Ïù¥ÎèôÌï©ÎãàÎã§.\n"Ï∑®ÏÜå"Î•º ÎàÑÎ•¥Î©¥ Ï†ÄÏû•ÌïòÏßÄ ÏïäÍ≥† Ïù¥ÎèôÌï©ÎãàÎã§.')) {
                    saveCurrentProgress();
                }
            }
            window.location.href = 'quiz.html';
        }

        function goHome() {
            if (confirm('Î¨∏Ï†ú ÌíÄÏù¥Î•º Ï§ëÎã®ÌïòÍ≥† Ï≤òÏùåÎ∂ÄÌÑ∞ Îã§Ïãú ÏãúÏûëÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n\nÏßÑÌñâ ÏÉÅÌô©ÏùÄ Ï†ÄÏû•ÎêòÏßÄ ÏïäÏäµÎãàÎã§.')) {
                localStorage.removeItem('quizProgress');
                localStorage.removeItem('randomQuestions');
                window.location.href = 'index.html';
            }
        }

        window.addEventListener('beforeunload', (e) => {
            if (currentQuestionIndex < currentQuestions.length && !document.querySelector('.completion-screen')) {
                saveCurrentProgress();
                e.preventDefault();
                e.returnValue = 'ÏßÑÌñâ ÏÉÅÌô©Ïù¥ ÏûêÎèô Ï†ÄÏû•Îê©ÎãàÎã§. ÌéòÏù¥ÏßÄÎ•º ÎÇòÍ∞ÄÏãúÍ≤†ÏäµÎãàÍπå?';
            }
        });

        // üÜï ÏÇ¨Ïö©Ïûê Í≥†Ïú† ID ÏÉùÏÑ± Ìï®Ïàò
        function getUserId() {
            let userId = localStorage.getItem('anonymousUserId');
            if (!userId) {
                userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('anonymousUserId', userId);
            }
            return userId;
        }

        // üÜï ÏÉÅÏÑ∏ ÎãµÏïà Í∏∞Î°ù Ï†ÄÏû• Ìï®Ïàò
        function saveDetailedAnswer(question, userAnswer, correctAnswer, isCorrect) {
            try {
                const detailedAnswers = JSON.parse(localStorage.getItem('detailedAnswers') || '[]');
                
                const answerRecord = {
                    userId: getUserId(),
                    examId: config.session || 'unknown',
                    examName: config.examName || '',
                    categoryName: config.categoryName || '',
                    questionId: generateQuestionId(question, currentQuestionIndex),
                    questionNumber: question.id || currentQuestionIndex + 1,
                    subject: question.subject || 'Í∏∞ÌÉÄ',
                    year: question.year || config.sessionInfo?.year || '',
                    session: question.session || config.sessionInfo?.session || '',
                    questionText: (question.question || '').substring(0, 100),
                    userAnswer: userAnswer,
                    correctAnswer: correctAnswer,
                    isCorrect: isCorrect,
                    timestamp: new Date().toISOString(),
                    timeSpent: Date.now() - startTime,
                    mode: mode || 'full'
                };
                
                detailedAnswers.push(answerRecord);
                
                if (detailedAnswers.length > 5000) {
                    detailedAnswers.splice(0, detailedAnswers.length - 5000);
                }
                
                localStorage.setItem('detailedAnswers', JSON.stringify(detailedAnswers));
            } catch (e) {
                console.error('ÏÉÅÏÑ∏ ÎãµÏïà Ï†ÄÏû• Ïò§Î•ò:', e);
            }
        }
    </script>
</body>
</html>